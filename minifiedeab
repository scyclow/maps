&r.gradient?map(SCALE,.2,1.2,2.6,1.5):s&&i?max(1,1.1/SCALE):s&&t?max(1,.75/SCALE):s&&E?max(1,1.5/SCALE):a?max(1,1/SCALE):E?max(1,.7/SCALE):n?max(1,.7/SCALE):1}}),s=5/SCALE;for(let o=r-s;o<e+s;o+=a){let r=a;for(let e=t-s;e<n+s;e+=r){const t=!BORDER_BLEED&&BORDER_PADDING>0&&i(e,o)?LAYERS[0]:findActiveLayer(e,o);drawBackgroundStroke(e,o,t,r=a/E[t.ix].multiplier,E[t.ix])}}pop()}function drawBackgroundStroke(r,e,t,n,o){if(LOW_INK&&prb(.5))return;const i=rnd(n,2*n)*o.multiplier/3.5,a=o.multiplier>1?2*i:0,E=getElevation(r,e);strokeWeight(i);let s=0,c=0,d=0;if(t.gradient){const n=t.gradient.useElevation?10*E:dist(r,e,t.gradient.focalPoint.x,t.gradient.focalPoint.y)/dist(L,B,R,T);s=map(n,0,1,0,t.gradient.hue),c=map(n,0,1,0,t.gradient.sat),d=map(n,0,1,0,t.gradient.brt)}const{bShadow:_,sShadow:l}=getShadow(r,e,E,t),A=45*GRAIN+3,S=10*GRAIN+5,h=5*GRAIN*(o.potentialMismatch?0:1);stroke(adjColor(hfix(hue(t.colors.bg)+s+rnd(-A,A)),saturation(t.colors.bg)+c+rnd(-S,S)+l,brightness(t.colors.bg)+d+rnd(-10-h,0)-_));const O=noise(r+NOISE_OFFSET,e+NOISE_OFFSET),[I,D]=getXYRotation(PI+O+rnd(NEG_Q_PI,Q_PI),5,r+rnd(-a,a+SMUDGE),e+rnd(-a,a)),[C,g]=getXYRotation(O+rnd(NEG_Q_PI,Q_PI),5,r,e);line(I,D,C,g)}function getShadow(r,e,t,n){const o=max(0,getElevation(r+SHADOW_X,e+SHADOW_Y)-t)*SHADOW_MAGNITUDE*(NOISE_DIVISOR*SCALE)/300,i=map(luminance(n.colors.bg),0,255,.5,1),a=n.gradient?4*min(abs(n.gradient.hue)/50,1):1;let E=0,s=0;return n.isDark?(E=500*o,s=500*o):n.isColor?(magnitude=150*a*i,E=o*magnitude,s=o*magnitude*(n.gradient?4:2)):n.isLight&&(E=100*o*a,s=100*o*a),{sShadow:s,bShadow:E}}function drawStreetGrid(r,e){push();const{primaryAveCoords:t,secondaryAveCoords:n,tertiaryAveCoords:o,quarternaryAveCoords:i,streetCoords:a}=generateAllCoords(),E=TURBULENCE?1.75:.5,s=TURBULENCE?1.25:0,R=.4*E,c=1.6*s,d=.8*E,_=1.2*s;a.forEach(t=>drawCoords(t.coords,(t,n)=>{const o=t+rnd(-R,R)+r,i=n+rnd(-R,R)+e,a=findActiveLayer(o,i);a.hideStreets||hideStreetsOverride(a.ix)||(setC(o,i,a.colors.street,a.gradient),STREET_TURBULENCE?times(LOW_INK?2:5,()=>{const r=nsrnd(o,i,0,20);circle(o+rnd(-r,r),i+rnd(-r,r),rnd(1*MIN_ST_W,1*MAX_ST_W))}):circle(o,i,nsrnd(o,i,MIN_ST_W,MAX_ST_W)+c))},r,e)),i.forEach(t=>drawCoords(t.coords,(t,n)=>{const o=t+rnd(-d,d)+r,i=n+rnd(-d,d)+e,a=findActiveLayer(o,i);a.hideStreets||hideStreetsOverride(a.ix)||(setC(o,i,a.colors.quarternary,a.gradient),circle(o,i,nsrnd(o,i,2*MIN_ST_W,2*MAX_ST_W)+_))},r,e)),o.forEach(t=>drawCoords(t.coords,(t,n)=>{const o=t+rnd(-E,E)+r,i=n+rnd(-E,E)+e,a=findActiveLayer(o,i);a.hideStreets||hideStreetsOverride(a.ix)||(setC(o,i,a.colors.tertiary,a.gradient),circle(o,i,nsrnd(o,i,3.5*MIN_ST_W,3.5*MAX_ST_W)+s))},r,e)),n.forEach(t=>drawCoords(t.coords,(t,n)=>{const o=t+rnd(-E,E)+r,i=n+rnd(-E,E)+e,a=findActiveLayer(o,i);a.hideStreets||hideStreetsOverride(a.ix)||(setC(o,i,a.colors.secondary,a.gradient),circle(o,i,nsrnd(o,i,5*MIN_ST_W,5*MAX_ST_W)+s))},r,e)),drawCoords(t.coords,(t,n)=>{const o=t+rnd(-E,E)+r,i=n+rnd(-E,E)+e,a=findActiveLayer(o,i);a.hideStreets||hideStreetsOverride(a.ix)||(setC(o,i,a.colors.primary,a.gradient),circle(o,i,nsrnd(o,i,6.25*MIN_ST_W,6.25*MAX_ST_W)+s))},r,e),pop()}function drawCoords(r,e,t=0,n=0){const o=createBorderFn(BORDER_PADDING),i=prb(DASH_RATE);r.forEach((a,E)=>{const{x:s,y:R}=a;if(E>0){const{x:t,y:n}=r[E-1];dotLine(t,n,s,R,e,o,i)}if(!o(s,R)&&E===r.length-1&&!IGNORE_STREET_CAP&&!STREET_TURBULENCE){push();const r=findActiveLayer(s+t,R+n);if(r.hideStreets||hideStreetsOverride(r.ix)||LOW_INK&&prb(.8))return;setC(s+t,R+n,r.colors.circle,r.gradient);const e=TURBULENCE;times(10,()=>{const r=STAR_MAP&&prb(.001)?drawStar:circle,o=LOW_INK?rnd(1,6):8;r(s+rnd(-e,e)+t,R+rnd(-e,e)+n,o)}),pop()}})}function generateAllCoords(){const r=map(SCALE,.2,1.2,.1,.17),e=0===DENSITY?.05:2===DENSITY&&.5,t=(r,t,n,o=1)=>e?e*o:r+(t-r)*(1-getElevation(n.x,n.y));SECONDARY_PRB=e||rnd(r,.2),TERTIARY_PRB=e?1.5*e:rnd(r,.2),QUARTERNARY_PRB=e?1.5*e:rnd(2*r,.4),STREET_PRB=e?2*e:rnd(.25,1),STREET_BLOCK_HEIGHT=20;const n=STRAIGHT_STREETS?100:scaleModifier(17,24);PRIMARY_DRIFT=HALF_PI/n,SECONDARY_DRIFT=HALF_PI/rnd(n,2*n),TERTIARY_DRIFT=HALF_PI/(HARD_CURVES?2:rnd(3*n,6*n)),QUARTERNARY_DRIFT=HALF_PI/(HARD_CURVES?2:rnd(3*n,6*n)),STREET_DRIFT=HALF_PI/(HARD_CURVES?2:rnd(3*n,6*n));const o=rnd(T,B),i=rnd(L,R),a=generateStreetCoords(...chance([.25,[i,B+25,lineStats(i,B,0,0).angle]],[.25,[i,T-25,lineStats(i,T,0,0).angle]],[.25,[L-25,o,lineStats(L,o,0,0).angle]],[.25,[R+25,o,lineStats(R,o,0,0).angle]]),{driftAmt:PRIMARY_DRIFT,maxLen:300,ix:0});let E=0,s={};const c=a.coords.map((e,n)=>{const o=t(r,.2,e);if(prb(o)&&n<250){const r=E++,t=rnd()<.5?1:-1;if(s[t]&&s[t]+3>n)return;s[t]=n;const o=-1===t?HALF_PI:PI+HALF_PI;return generateStreetCoords(e.x,e.y,e.angle+o,{direction:t,branch:r,driftAmt:SECONDARY_DRIFT,maxLen:200})}}).filter(exists),d=c.flatMap((e,n)=>e.coords.map(e=>{const o=t(r,.2,e,1.5);if(prb(o)&&n<150){const r=rnd()<.5?1:-1,t=-1===r?HALF_PI:PI+HALF_PI,n={direction:r,driftAmt:TERTIARY_DRIFT,stopAtIntersections:[a,...c]};return generateStreetCoords(e.x,e.y,e.angle+t,n)}}).filter(exists)),_=d.flatMap(e=>e.coords.map(e=>{const n=t(2*r,.4,e,1.5);if(prb(n)){const r=rnd()<.5?1:-1,t=-1===r?HALF_PI:PI+HALF_PI,n={direction:r,driftAmt:QUARTERNARY_DRIFT,stopAtIntersections:[a,...c,...d]};return generateStreetCoords(e.x,e.y,e.angle+t,n)}}).filter(exists)),l=c.flatMap(r=>r.coords.flatMap(r=>{const e={driftAmt:STREET_DRIFT,stopAtIntersections:[a,...c,...d,..._]},n=t(.25,1,r,2);return[prb(n)&&generateStreetCoords(r.x,r.y,r.angle+HALF_PI,e),prb(n)&&generateStreetCoords(r.x,r.y,r.angle+HALF_PI+PI,e)].filter(exists)}));return{primaryAveCoords:a,secondaryAveCoords:c,tertiaryAveCoords:d,quarternaryAveCoords:_,streetCoords:l}}function generateStreetCoords(r,e,t,n={}){const o=n.driftAmt||HALF_PI/16,i=n.stopAtIntersections||[],a=n.maxLen||150,E=createBorderFn(-180/SCALE);let s=r,R=e,c=t;const d=[];for(let r=0;r<a;r++){const e=getXYRotation((c=map(noise(s+NOISE_OFFSET,R+NOISE_OFFSET),0,1,c-o,c+o))+(KINKED_STREET_FACTOR&&findActiveLayer(s,R).ix>0?KINKED_STREET_FACTOR:0),STREET_BLOCK_HEIGHT,s,R),t=e[0],n=e[1];if(r&&findIntersectionPoint({x:s,y:R},{x:t,y:n},i))break;if(s=t,R=n,d.push({x:s,y:R,angle:c}),E(s,R))break}return{coords:d,direction:n.direction||0,branch:n.branch||0}}const drawStar=(r,e,t)=>{push();const n=n=>getXYRotation(n*TWO_PI/10,n%2==0?t/2:t,r,e);beginShape(),curveVertex(...n(-1)),times(12,r=>{curveVertex(...n(r))}),endShape(),pop()};function drawBorder(){if(HARD_BORDER){const r=BORDER_PADDING<50?rnd(1.7,2.1):rnd(1.98,2.02);let e=0;const t=t=>{dotRect(X_OFF,Y_OFF,W-BORDER_PADDING*r,H-BORDER_PADDING*r,(r,n)=>{const o=BORDER_BLEED?findActiveLayer(r,n,!0):LAYERS[0];(t||!o.hideStreets&&!hideStreetsOverride(o.ix))&&(e++,setC(r+X_OFF,n+Y_OFF,o.colors.circle,o.gradient),circle(r,n,nsrnd(r,n,BORDER_THICKNESS/SCALE,2.5*BORDER_THICKNESS/SCALE)))})};t(),e<100&&t(!0)}}const Q_PI=Math.PI/4,NEG_Q_PI=-Math.PI/4;function setup(){SIZE=min(window.innerWidth,window.innerHeight),__canvas=createCanvas(SIZE,SIZE),noiseSeed(rnd(1e6)+rnd(1e6)+rnd(1e3)),colorMode(HSB,360,100,100),SCALE=rnd()+.2,SCALE_ADJ=SIZE/800;const r=SCALE*SCALE_ADJ;W=width/r,H=height/r,L=round(-width/(2*r),4),R=round(width/(2*r),4),T=round(-height/(2*r),4),B=round(height/(2*r),4),setFeatures(),setLayers(),console.log(JSON.stringify({HASH:tokenData.hash,SCALE:SCALE,COLOR_RULE:COLOR_RULE,LAYER_N:LAYER_N,BASE_RULE:BASE_RULE,HUE_DIFF:HUE_DIFF,FORCE_GRADIENTS:FORCE_GRADIENTS,HARD_CURVES:HARD_CURVES,DASH_RATE:DASH_RATE.toPrecision(2),STREET_TURBULENCE:STREET_TURBULENCE,NOISE_DIVISOR:(NOISE_DIVISOR*SCALE).toPrecision(4),DENSITY:DENSITY,TURBULENCE:TURBULENCE,IGNORE_STREET_CAP:IGNORE_STREET_CAP,KINKED_STREET_FACTOR:KINKED_STREET_FACTOR,HARD_BORDER:HARD_BORDER,BORDER_BLEED:BORDER_BLEED,BORDER_DRIFT:(BORDER_DRIFT*SCALE).toPrecision(4),BORDER_THICKNESS:BORDER_THICKNESS.toPrecision(2),BORDER_PADDING:(BORDER_PADDING*SCALE).toPrecision(4),ROTATION:ROTATION.toPrecision(2),STRAIGHT_STREETS:STRAIGHT_STREETS,X_OFF:X_OFF,Y_OFF:Y_OFF,MISPRINT_ROTATION:MISPRINT_ROTATION,MAX_GRADIENT:MAX_GRADIENT,GRAIN:GRAIN,SMUDGE:SMUDGE,STAR_MAP:STAR_MAP,LOW_INK:LOW_INK,HUE_RULE:HUE_RULE,SHADOW_X:SHADOW_X,SHADOW_Y:SHADOW_Y,SHADOW_MAGNITUDE:SHADOW_MAGNITUDE},null,2)),console.log(LAYERS)}function draw(){noLoop();const r=Date.now();translate(width/2,height/2),scale(SCALE*SCALE_ADJ);const e=1.5*max(abs(X_OFF),abs(Y_OFF));rotate(MISPRINT_ROTATION),drawBackground(T-e,B+e,L-e,R+e),rotate(ROTATION),drawStreetGrid(X_OFF,Y_OFF),drawBorder(),console.log(Date.now()-r)}function setSize(){}function setFeatures(){TURBULENCE=prb(.15),STREET_TURBULENCE=prb(.1),IGNORE_STREET_CAP=prb(.1),HARD_CURVES=prb(.05),STRAIGHT_STREETS=prb(scaleModifier(.05,.1)),STAR_MAP=prb(.02),LOW_INK=prb(.01),SMUDGE=prb(.01)?rnd(30,100):0,KINKED_STREET_FACTOR=prb(.15)?rnd(QUARTER_PI/2,QUARTER_PI)*posOrNeg():0,NOISE_DIVISOR=rnd(150,750)/SCALE,DENSITY=chance([SCALE>=.8?.0025:.015,0],[.97,1],[.05,2]),DASH_RATE=prb(.125)?rnd(.05,.2):0,COLOR_RULE=chance([40,0],[15,1],[5,2],[11,3],[27,4],[SCALE>=1&&TURBULENCE?0:2,5]);const r=STREET_TURBULENCE||HARD_CURVES?10:map(SCALE,1.2,.2,1,15);LAYER_N=chance([r,1],[6,2],[36,3],[34,rndint(4,7)],[HARD_CURVES?0:10,rndint(7,10)],[HARD_CURVES?0:4,rndint(10,15)],[HARD_CURVES?0:1,30]),BASE_RULE=chance([LAYER_N<=4?20:0,"paper"],[LAYER_N<=4?20:0,"faded"],[LAYER_N<=4?15:0,"burnt"],[LAYER_N<=4?10:5,"bright"],[6,"whiteAndBlack"],[4,"blackAndWhite"],[SCALE<=.3?0:4,"neon"]),HUE_DIFF=chance([3,0],[2,20],[1,100],[2,120],[1,150],[3,180])*posOrNeg(),FORCE_GRADIENTS=prb(.02),MAX_GRADIENT=prb(.025)?rnd(720,3e3):200,INVERT_STREETS=!1,LIGHTEN_DARKS=!1,HUE_RULE=sample(["path","preset"]),1===COLOR_RULE?(HUE_DIFF=0,LAYER_N=chance([6,3],[1,4],[1,5]),BASE_RULE=chance([7,"bright"],[3,"whiteAndBlack"],[5,"blackAndWhite"],[5,"neon"])):3===COLOR_RULE?(BASE_RULE=chance([20,"burnt"],[5,"blackAndWhite"],[5,"neon"]),TURBULENCE=rnd()<.4,STREET_TURBULENCE=rnd()<.3,LIGHTEN_DARKS=!0):4===COLOR_RULE?(BASE_RULE=chance([20,"faded"],[30,"bright"],[10,"paper"],[30,"whiteAndBlack"]),LAYER_N=chance([25,3],[35,rndint(4,6)],[25,rndint(6,9)],[HARD_CURVES?0:10,rndint(9,15)],[HARD_CURVES?0:5,rndint(15,30)]),HUE_DIFF=chance([LAYER_N>=12?2:1,10],[4,20],[LAYER_N>=12?1:2,100],[3,120],[LAYER_N>=12?1:3,150],[3,180])*posOrNeg(),prb(.05)?(F
const setC=(r,e,t,n)=>{if(n){const o=n.useElevation?10*getElevation(r,e):dist(r,e,n.focalPoint.x,n.focalPoint.y)/dist(L,B,R,T),i=adjColor(hfix(hue(t)+map(o,0,1,0,n.hue)),saturation(t)+map(o,0,1,0,n.sat),brightness(t)+map(o,0,1,0,n.brt));stroke(i),fill(i)}else stroke(t),fill(t)},isBrightColor=r=>r>=90&&r<=150||r>=270&&r<=330;function adjColor(r,e,t){r=hfix(r);let n=0;return isBrightColor(r)&&(n=1-abs(120-r%180)/30),e=map(n,0,1,e,.65*e),color(r,e,t)}const noop=()=>{};function scaleModifier(r,e){const t=SCALE<.4&&SCALE>=.3?.05:SCALE<.3?.35-SCALE:0;return map(t,0,.15,r,e)}const coordToTuple=({x:r,y:e})=>[r,e];function findIntersectionPoint(r,e,t){if(!t.length)return!1;const n=coordToTuple(r),o=coordToTuple(e);return t.some(t=>{if(t.coords.length<10)return intersects(coordToTuple(r),coordToTuple(e),coordToTuple(t.coords[0]),coordToTuple(last(t.coords)));const i=t.coords.length<20?2:t.coords.length<40?4:t.coords.length<70?7:10;for(let r=0;r<t.coords.length;r+=i){const e=coordToTuple(t.coords[r]),a=coordToTuple(t.coords[r+i]||last(t.coords)),E=intersects(n,o,e,a);if(E)return E}return!1})}const createBorderFn=r=>(e,t)=>e<L+r+rnd(-BORDER_DRIFT,BORDER_DRIFT)||e>R-r+rnd(-BORDER_DRIFT,BORDER_DRIFT)||t<T+r+rnd(-BORDER_DRIFT,BORDER_DRIFT)||t>B-r+rnd(-BORDER_DRIFT,BORDER_DRIFT);function dotLine(r,e,t,n,o,i=noop,a=!1){const{d:E,angle:s}=lineStats(r,e,t,n);let R=r,c=e;for(let r=0;r<=E;r++){if(a&&r>=.6*E)return;i(R,c)||LOW_INK&&prb(.7)||TURBULENCE&&prb(.2)||o(R,c,r/E,s),[R,c]=getXYRotation(s,1,R,c)}}function dotRect(r,e,t,n,o){dotLine(r-t/2,e-n/2,r+t/2,e-n/2,o),dotLine(r-t/2,e+n/2,r+t/2,e+n/2,o),dotLine(r-t/2,e-n/2,r-t/2,e+n/2,o),dotLine(r+t/2,e-n/2,r+t/2,e+n/2,o)}function chance(...r){const e=r.reduce((r,e)=>r+e[0],0),t=rnd();let n=0;for(let o=0;o<r.length;o++)if(t<=(n+=r[o][0]/e))return r[o][1]}const lineStats=(r,e,t,n)=>({d:dist(r,e,t,n),angle:atan2(t-r,n-e)});function inPolygon(r,e){if(dist(r[0],r[1],e.x,e.y)>e.r)return!1;const t=[2*width,2*height];return e.coords.reduce((n,o,i)=>{const a=(i+1)%e.coords.length,E=e.coords[a];return intersects(r,t,o,E)?n+1:n},0)%2==1}function intersects([r,e],[t,n],[o,i],[a,E]){const s=(t-r)*(E-i)-(a-o)*(n-e);if(0===s)return!1;const R=((E-i)*(a-r)+(o-a)*(E-e))/s,c=((e-n)*(a-r)+(t-r)*(E-e))/s;return R>0&&R<1&&c>0&&c<1?[r+R*(t-r),e+R*(n-e)]:null}function getXYRotation(r,e,t=0,n=0){return[sin(r)*e+t,cos(r)*e+n]}function times(r,e){const t=[];for(let n=0;n<r;n++)t.push(e(n));return t}let __randomSeed=parseInt(tokenData.hash.slice(50,58),16);const rndint=(r,e)=>int(rnd(r,e));function rnd(r,e){__randomSeed^=__randomSeed<<13,__randomSeed^=__randomSeed>>17;const t=((__randomSeed^=__randomSeed<<5)<0?1+~__randomSeed:__randomSeed)%1e3/1e3;return null!=e?r+t*(e-r):null!=r?t*r:t}function hshrnd(r){const e=tokenData.hash.slice(2+2*r,4+2*r);return parseInt(e,16)/255}const prb=r=>rnd()<r,nsrnd=(r,e,t,n)=>t+noise(r/15,e/15)*(n-t)+rnd(-.25,.25),posOrNeg=()=>prb(.5)?1:-1,sample=r=>r[int(rnd(r.length))],exists=r=>!!r,last=r=>r[r.length-1],hfix=r=>(r%360+360)%360,luminance=r=>(299*red(r)+587*green(r)+114*blue(r))/1e3,contrast=(r,e)=>(luminance(r)-luminance(e))/255;function setLayers(){const{elevationAverage:r,elevationMin:e}=findAvgElevation(),t=rules(),n=rnd(360);LAYERS=[{ix:0,threshold:LAYER_N>=30?e:r,hideStreets:!1,...t[BASE_RULE](n,MAX_GRADIENT/rnd(3,15),0,LIGHTEN_DARKS)}];const o=["whiteAndBlack","paper"].includes(BASE_RULE),i=["bright","faded"].includes(BASE_RULE),a=5===COLOR_RULE&&i?sample(["bright","whiteAndBlack"]):!(5!==COLOR_RULE||!o)&&"bright";let E=0;const s=getHuePresets(n),R=(r,e,n)=>{const o=prb(.2)&&!MISPRINT_ROTATION,i=n===LAYER_N-1?MAX_GRADIENT/rnd(3,8):MAX_GRADIENT;let R;if(5!==COLOR_RULE||n%2)if(5===COLOR_RULE&&n%2){chance([1,20],[1,120],[1,180]);const e=hfix(r.baseHue+20);R=t[a](e,i,n,r.isDark)}else{const e=chance(...r.neighbors),o="blackAndWhite"===e||"whiteAndBlack"===e?r.baseHue:(r=>"path"===HUE_RULE?r+HUE_DIFF:s[E++%s.length])(r.baseHue);R=t[e](o,i,n,r.isDark)}else R=LAYERS[0];return{hideStreets:o,...R,ix:n,threshold:e}};for(let r=1;r<LAYER_N;r++){const e=LAYERS[r-1],t=r===LAYER_N-1?1:e.threshold+.02;LAYERS.push(R(e,t,r))}}const rules=()=>{const r=color(0,0,10),e=color(0,0,90),t=color(0,0,85),n=(r,e=360)=>rnd()<.09||r?{focalPoint:{x:rnd(L,R),y:rnd(T,B)},useElevation:rnd()<.9,hue:rnd(e/4,e)*posOrNeg(),sat:2,brt:1}:null;return{blackAndWhite:e=>{let n;return n=[2,4].includes(COLOR_RULE)?"light":3===COLOR_RULE?"dark":4===COLOR_RULE?"color":"all",{name:"blackAndWhite",baseHue:e,colors:{bg:r,primary:t,secondary:t,tertiary:t,quarternary:t,street:t,circle:t},neighbors:{contrast:[[1,"whiteAndBlack"],[1,"bright"]],light:[[8,"whiteAndBlack"],[2,"bright"]],dark:[[1,"neon"]],color:[[1,"bright"]],all:[[7,"whiteAndBlack"],[3,"bright"],[3,"neon"]]}[n],gradient:null,isDark:!0,isColor:!1,isLight:!1}},whiteAndBlack:t=>{let n;n=1===COLOR_RULE?"contrast":3===COLOR_RULE?"dark":[2,4].includes(COLOR_RULE)?"color":"all";const o={contrast:[[LAYER_N>3?1:0,"bright"],[3,"blackAndWhite"]],dark:[[5,"blackAndWhite"],[5,"neon"]],color:[[1,"bright"]],all:[[6,"blackAndWhite"],[5,"neon"],[5,"bright"]]}[n];return{name:"whiteAndBlack",baseHue:t,colors:{bg:e,primary:r,secondary:r,tertiary:r,quarternary:r,street:r,circle:r},neighbors:o,gradient:null,isDark:!1,isColor:!1,isLight:!0}},neon:(r,e,t,o)=>{const i=adjColor(r,30,o?22:12);let a,E=adjColor(r,55,92);return contrast(i,E)>-.5&&(E=setContrastC2(i,E,-.5)),{name:"neon",baseHue:r,colors:{bg:i,primary:E,secondary:E,tertiary:E,quarternary:E,street:E,circle:E},neighbors:{contrast:[[1,"bright"]],dark:[[2,"blackAndWhite"],[1,"neon"]],light:[[2,"whiteAndBlack"],[1,"bright"]],color:[[1,"bright"]],all:[[4,"bright"],[5,"blackAndWhite"],[3,"whiteAndBlack"],[2,"neon"]]}[a=2===LAYER_N?"color":1===COLOR_RULE?"contrast":2===COLOR_RULE?"light":3===COLOR_RULE?"dark":4===COLOR_RULE?"color":"all"],gradient:n(FORCE_GRADIENTS,e),isDark:!0,isColor:!1,isLight:!1}},bright:(r,e,t)=>{const o=INVERT_STREETS&&t,i=adjColor(r,55,95),a=o>0?invertStreetColor(r+180,50,85,i):color(hfix(r+180),30,15);let E;return E=1===COLOR_RULE?"contrast":2===COLOR_RULE?"light":3===COLOR_RULE?"dark":4===COLOR_RULE?"color":"all",{name:"bright",baseHue:r,colors:{bg:i,primary:a,secondary:a,tertiary:a,quarternary:a,street:a,circle:a},neighbors:{contrast:[[3,"blackAndWhite"],[LAYER_N>3?1:0,"whiteAndBlack"],[3,"neon"]],dark:[[2,"blackAndWhite"],[1,"neon"]],light:[[1,"whiteAndBlack"]],color:[[1,"bright"]],all:[[4,"blackAndWhite"],[2,"whiteAndBlack"],[1,"neon"]]}[E],invertStreets:o,gradient:n(FORCE_GRADIENTS,e),isDark:!1,isColor:!0,isLight:!1}},paper:(r,e)=>{const t=color(hfix(r),8,91),o=invertStreetColor(r+HUE_DIFF,60,30,t),i=invertStreetColor(r+HUE_DIFF-10,40,35,t),a=invertStreetColor(r+HUE_DIFF-20,40,35,t);let E;return E=2===COLOR_RULE?"light":3===COLOR_RULE?"dark":4===COLOR_RULE?"color":"all",{name:"paper",baseHue:r,colors:{bg:t,primary:o,secondary:o,tertiary:i,quarternary:i,street:a,circle:a},neighbors:{dark:[[1,"blackAndWhite"],[LAYER_N>2?1:0,"neon"],[1,"burnt"]],light:[[1,"whiteAndBlack"],[1,"bright"],[1,"faded"]],color:[[1,"bright"],[1,"faded"]],all:[[6,"blackAndWhite"],[LAYER_N>2?6:0,"neon"],[7,"burnt"],[1,"whiteAndBlack"],[1,"bright"],[2,"faded"]]}[E],gradient:n(!0,FORCE_GRADIENTS?e:rnd(90)),isDark:!1,isColor:!1,isLight:!0}},faded:(r,e)=>{const t=adjColor(r,35,95),o=invertStreetColor(r+HUE_DIFF,85,30,t),i=invertStreetColor(r+HUE_DIFF-10,85,30,t),a=invertStreetColor(r+HUE_DIFF-20,85,30,t);let E;return{name:"faded",baseHue:r,colors:{bg:t,primary:o,secondary:o,tertiary:i,quarternary:i,street:a,circle:a},neighbors:{dark:[[1,"blackAndWhite"],[1,"neon"],[2,"burnt"]],light:[[1,"whiteAndBlack"],[1,"bright"],[2,"paper"]],color:[[1,"bright"]],all:[[2,"burnt"],[2,"paper"],[12,"blackAndWhite"],[5,"neon"],[5,"whiteAndBlack"],[1,"bright"]]}[E=2===COLOR_RULE?"light":3===COLOR_RULE?"dark":4===COLOR_RULE?"color":"all"],gradient:n(FORCE_GRADIENTS,FORCE_GRADIENTS?e:rnd(75)),isDark:!1,isColor:!0,isLight:!1}},burnt:(r,e,t,o)=>{const i=color(hfix(r),35,o?17:15),a=HUE_DIFF>0?1:-1,E=color(hfix(r+HUE_DIFF),50,85),s=color(hfix(r+HUE_DIFF-30*a),50,85),R=color(hfix(r+HUE_DIFF-60*a),50,85);let c;return{name:"burnt",baseHue:r,colors:{bg:i,primary:E,secondary:E,tertiary:s,quarternary:s,street:R,circle:R},neighbors:{dark:[[3,"blackAndWhite"],[2,"neon"]],light:[[2,"whiteAndBlack"],[1,"bright"],[2,"faded"]],color:[[1,"bright"],[2,"faded"]],all:[[6,"whiteAndBlack"],[4,"faded"],[8,"blackAndWhite"],[4,"neon"],[7,"bright"]]}[c=2===LAYER_N?"color":2===COLOR_RULE?"light":3===COLOR_RULE?"dark":4===COLOR_RULE?"color":"all"],gradient:n(FORCE_GRADIENTS,e),isDark:!0,isColor:!1,isLight:!1}}}};function invertStreetColor(r,e,t,n){const o=hfix(r),i=isBrightColor(hue)?.9:.7;return setContrastC2(n,color(o,e,t),i)}function hideStreetsOverride(r){return SCALE>=1&&TURBULENCE&&r<LAYER_N-1&&r>0}function findActiveLayer(r,e){const t=getElevation(r,e);for(let r=0;r<LAYERS.length;r++)if(t<LAYERS[r].threshold)return LAYERS[r];return LAYERS[LAYERS.length-1]}function getHuePresets(r){switch(abs(HUE_DIFF)){case 0:return[r];case 10:return[r,r+10,r+20,r+30,r+40,r+50,r+60];case 20:return[r,r+20,r-20];case 100:return[r,r+120,r+180];case 120:return[r,r+120,r-120];case 150:return[r,r+150,r+210];case 180:return[r,r+180]}}function findAvgElevation(){let r=0,e=0,t=1,n=0;const o=30/SCALE;for(let i=L;i<R;i+=o)for(let a=T;a<B;a+=o){const o=getElevation(i,a);r+=o,o<t&&(t=o),o>n&&(n=o),e++}return{elevationAverage:r/e,elevationMin:t,elevationMax:n}}function getElevation(r,e){return noise(r/NOISE_DIVISOR+NOISE_OFFSET,e/NOISE_DIVISOR+NOISE_OFFSET)}const setContrast=(r,e,t=.4)=>{if(_contrast=contrast(r,e),_contrast<0){const n=(t+_contrast)/.3;return{c1:color(hue(r),saturation(r)+20*n,brightness(r)-30*n),c2:e}}{const n=(t-_contrast)/.3;return{c2:color(hue(e),saturation(e)+20*n,brightness(e)-30*n),c1:r}}},setContrastC2=(r,e,t=.4)=>{const n=(t-contrast(r,e))/.3;return color(hue(e),saturation(e)+20*n,brightness(e)-30*n)};function drawBackground(r,e,t,n){push();const o=LAYERS[0];background(o.colors.bg);const i=createBorderFn(BORDER_PADDING),a=2/SCALE,E=LAYERS.map((r,e)=>{const t=r.isColor&&o.isDark,n=r.isLight&&o.isDark,i=o.isColor&&r.isDark,a=t||i,E=o.isLight&&r.isDark,s=0===e||e===LAYERS.length-1;return{potentialMismatch:a||E,multiplier:s&&r.gradient?map(SCALE,.2,1.2,2.6,1.5):s&&i?max(1,1.1/SCALE):s&&t?max(1,.75/SCALE):s&&E?max(1,1.5/SCALE):a?max(1,1/SCALE):E?max(1,.7/SCALE):n?max(1,.7/SCALE):1}}),s=5/SCALE;for(let o=r-s;o<e+s;o+=a){let r=a;for(let e=t-s;e<n+s;e+=r){const t=!BORDER_BLEED&&BORDER_PADDING>0&&i(e,o)?LAYERS[0]:findActiveLayer(e,o);drawBackgroundStroke(e,o,t,r=a/E[t.ix].multiplier,E[t.ix])}}pop()}function drawBackgroundStroke(r,e,t,n,o){if(LOW_INK&&prb(.5))return;const i=rnd(n,2*n)*o.multiplier/3.5,a=o.multiplier>1?2*i:0,E=getElevation(r,e);strokeWeight(i);let s=0,c=0,d=0;if(t.gradient){const n=t.gradient.useElevation?10*E:dist(r,e,t.gradient.focalPoint.x,t.gradient.focalPoint.y)/dist(L,B,R,T);s=map(n,0,1,0,t.gradient.hue),c=map(n,0,1,0,t.gradient.sat),d=map(n,0,1,0,t.gradient.brt)}const{bShadow:_,sShadow:l}=getShadow(r,e,E,t),A=45*GRAIN+3,S=10*GRAIN+5,h=5*GRAIN*(o.potentialMismatch?0:1);stroke(adjColor(hfix(hue(t.colors.bg)+s+rnd(-A,A)),saturation(t.colors.bg)+c+rnd(-S,S)+l,brightness(t.colors.bg)+d+rnd(-10-h,0)-_));const O=noise(r+NOISE_OFFSET,e+NOISE_OFFSET),[I,D]=getXYRotation(PI+O+rnd(NEG_Q_PI,Q_PI),5,r+rnd(-a,a+SMUDGE),e+rnd(-a,a)),[C,g]=getXYRotation(O+rnd(NEG_Q_PI,Q_PI),5,r,e);line(I,D,C,g)}function getShadow(r,e,t,n){const o=max(0,getElevation(r+SHADOW_X,e+SHADOW_Y)-t)*SHADOW_MAGNITUDE*(NOISE_DIVISOR*SCALE)/300,i=map(luminance(n.colors.bg),0,255,.5,1),a=n.gradient?4*min(abs(n.gradient.hue)/50,1):1;let E=0,s=0;return n.isDark?(E=500*o,s=500*o):n.isColor?(magnitude=150*a*i,E=o*magnitude,s=o*magnitude*(n.gradient?4:2)):n.isLight&&(E=100*o*a,s=100*o*a),{sShadow:s,bShadow:E}}function drawStreetGrid(r,e){push();const{primaryAveCoords:t,secondaryAveCoords:n,tertiaryAveCoords:o,quarternaryAveCoords:i,streetCoords:a}=generateAllCoords(),E=TURBULENCE?1.75:.5,s=TURBULENCE?1.25:0,R=.4*E,c=1.6*s,d=.8*E,_=1.2*s;a.forEach(t=>drawCoords(t.coords,(t,n)=>{const o=t+rnd(-R,R)+r,i=n+rnd(-R,R)+e,a=findActiveLayer(o,i);a.hideStreets||hideStreetsOverride(a.ix)||(setC(o,i,a.colors.street,a.gradient),STREET_TURBULENCE?times(LOW_INK?2:5,()=>{const r=nsrnd(o,i,0,20);circle(o+rnd(-r,r),i+rnd(-r,r),rnd(1*MIN_ST_W,1*MAX_ST_W))}):circle(o,i,nsrnd(o,i,MIN_ST_W,MAX_ST_W)+c))},r,e)),i.forEach(t=>drawCoords(t.coords,(t,n)=>{const o=t+rnd(-d,d)+r,i=n+rnd(-d,d)+e,a=findActiveLayer(o,i);a.hideStreets||hideStreetsOverride(a.ix)||(setC(o,i,a.colors.quarternary,a.gradient),circle(o,i,nsrnd(o,i,2*MIN_ST_W,2*MAX_ST_W)+_))},r,e)),o.forEach(t=>drawCoords(t.coords,(t,n)=>{const o=t+rnd(-E,E)+r,i=n+rnd(-E,E)+e,a=findActiveLayer(o,i);a.hideStreets||hideStreetsOverride(a.ix)||(setC(o,i,a.colors.tertiary,a.gradient),circle(o,i,nsrnd(o,i,3.5*MIN_ST_W,3.5*MAX_ST_W)+s))},r,e)),n.forEach(t=>drawCoords(t.coords,(t,n)=>{const o=t+rnd(-E,E)+r,i=n+rnd(-E,E)+e,a=findActiveLayer(o,i);a.hideStreets||hideStreetsOverride(a.ix)||(setC(o,i,a.colors.secondary,a.gradient),circle(o,i,nsrnd(o,i,5*MIN_ST_W,5*MAX_ST_W)+s))},r,e)),drawCoords(t.coords,(t,n)=>{const o=t+rnd(-E,E)+r,i=n+rnd(-E,E)+e,a=findActiveLayer(o,i);a.hideStreets||hideStreetsOverride(a.ix)||(setC(o,i,a.colors.primary,a.gradient),circle(o,i,nsrnd(o,i,6.25*MIN_ST_W,6.25*MAX_ST_W)+s))},r,e),pop()}function drawCoords(r,e,t=0,n=0){const o=createBorderFn(BORDER_PADDING),i=prb(DASH_RATE);r.forEach((a,E)=>{const{x:s,y:R}=a;if(E>0){const{x:t,y:n}=r[E-1];dotLine(t,n,s,R,e,o,i)}if(!o(s,R)&&E===r.length-1&&!IGNORE_STREET_CAP&&!STREET_TURBULENCE){push();const r=findActiveLayer(s+t,R+n);if(r.hideStreets||hideStreetsOverride(r.ix)||LOW_INK&&prb(.8))return;setC(s+t,R+n,r.colors.circle,r.gradient);const e=TURBULENCE;times(10,()=>{const r=STAR_MAP&&prb(.001)?drawStar:circle,o=LOW_INK?rnd(1,6):8;r(s+rnd(-e,e)+t,R+rnd(-e,e)+n,o)}),pop()}})}function generateAllCoords(){const r=map(SCALE,.2,1.2,.1,.17),e=0===DENSITY?.05:2===DENSITY&&.5,t=(r,t,n,o=1)=>e?e*o:r+(t-r)*(1-getElevation(n.x,n.y));SECONDARY_PRB=e||rnd(r,.2),TERTIARY_PRB=e?1.5*e:rnd(r,.2),QUARTERNARY_PRB=e?1.5*e:rnd(2*r,.4),STREET_PRB=e?2*e:rnd(.25,1),STREET_BLOCK_HEIGHT=20;const n=STRAIGHT_STREETS?100:scaleModifier(17,24);PRIMARY_DRIFT=HALF_PI/n,SECONDARY_DRIFT=HALF_PI/rnd(n,2*n),TERTIARY_DRIFT=HALF_PI/(HARD_CURVES?2:rnd(3*n,6*n)),QUARTERNARY_DRIFT=HALF_PI/(HARD_CURVES?2:rnd(3*n,6*n)),STREET_DRIFT=HALF_PI/(HARD_CURVES?2:rnd(3*n,6*n));const o=rnd(T,B),i=rnd(L,R),a=generateStreetCoords(...chance([.25,[i,B+25,lineStats(i,B,0,0).angle]],[.25,[i,T-25,lineStats(i,T,0,0).angle]],[.25,[L-25,o,lineStats(L,o,0,0).angle]],[.25,[R+25,o,lineStats(R,o,0,0).angle]]),{driftAmt:PRIMARY_DRIFT,maxLen:300,ix:0});let E=0,s={};const c=a.coords.map((e,n)=>{const o=t(r,.2,e);if(prb(o)&&n<250){const r=E++,t=rnd()<.5?1:-1;if(s[t]&&s[t]+3>n)return;s[t]=n;const o=-1===t?HALF_PI:PI+HALF_PI;return generateStreetCoords(e.x,e.y,e.angle+o,{direction:t,branch:r,driftAmt:SECONDARY_DRIFT,maxLen:200})}}).filter(exists),d=c.flatMap((e,n)=>e.coords.map(e=>{const o=t(r,.2,e,1.5);if(prb(o)&&n<150){const r=rnd()<.5?1:-1,t=-1===r?HALF_PI:PI+HALF_PI,n={direction:r,driftAmt:TERTIARY_DRIFT,stopAtIntersections:[a,...c]};return generateStreetCoords(e.x,e.y,e.angle+t,n)}}).filter(exists)),_=d.flatMap(e=>e.coords.map(e=>{const n=t(2*r,.4,e,1.5);if(prb(n)){const r=rnd()<.5?1:-1,t=-1===r?HALF_PI:PI+HALF_PI,n={direction:r,driftAmt:QUARTERNARY_DRIFT,stopAtIntersections:[a,...c,...d]};return generateStreetCoords(e.x,e.y,e.angle+t,n)}}).filter(exists)),l=c.flatMap(r=>r.coords.flatMap(r=>{const e={driftAmt:STREET_DRIFT,stopAtIntersections:[a,...c,...d,..._]},n=t(.25,1,r,2);return[prb(n)&&generateStreetCoords(r.x,r.y,r.angle+HALF_PI,e),prb(n)&&generateStreetCoords(r.x,r.y,r.angle+HALF_PI+PI,e)].filter(exists)}));return{primaryAveCoords:a,secondaryAveCoords:c,tertiaryAveCoords:d,quarternaryAveCoords:_,streetCoords:l}}function generateStreetCoords(r,e,t,n={}){const o=n.driftAmt||HALF_PI/16,i=n.stopAtIntersections||[],a=n.maxLen||150,E=createBorderFn(-180/SCALE);let s=r,R=e,c=t;const d=[];for(let r=0;r<a;r++){const e=getXYRotation((c=map(noise(s+NOISE_OFFSET,R+NOISE_OFFSET),0,1,c-o,c+o))+(KINKED_STREET_FACTOR&&findActiveLayer(s,R).ix>0?KINKED_STREET_FACTOR:0),STREET_BLOCK_HEIGHT,s,R),t=e[0],n=e[1];if(r&&findIntersectionPoint({x:s,y:R},{x:t,y:n},i))break;if(s=t,R=n,d.push({x:s,y:R,angle:c}),E(s,R))break}return{coords:d,direction:n.direction||0,branch:n.branch||0}}const drawStar=(r,e,t)=>{push();const n=n=>getXYRotation(n*TWO_PI/10,n%2==0?t/2:t,r,e);beginShape(),curveVertex(...n(-1)),times(12,r=>{curveVertex(...n(r))}),endShape(),pop()};function drawBorder(){if(HARD_BORDER){const r=BORDER_PADDING<50?rnd(1.7,2.1):rnd(1.98,2.02);let e=0;const t=t=>{dotRect(X_OFF,Y_OFF,W-BORDER_PADDING*r,H-BORDER_PADDING*r,(r,n)=>{const o=BORDER_BLEED?findActiveLayer(r,n,!0):LAYERS[0];(t||!o.hideStreets&&!hideStreetsOverride(o.ix))&&(e++,setC(r+X_OFF,n+Y_OFF,o.colors.circle,o.gradient),circle(r,n,nsrnd(r,n,BORDER_THICKNESS/SCALE,2.5*BORDER_THICKNESS/SCALE)))})};t(),e<100&&t(!0)}}const Q_PI=Math.PI/4,NEG_Q_PI=-Math.PI/4;function setup(){SIZE=min(window.innerWidth,window.innerHeight),__canvas=createCanvas(SIZE,SIZE),noiseSeed(rnd(1e6)+rnd(1e6)+rnd(1e3)),colorMode(HSB,360,100,100),SCALE=rnd()+.2,SCALE_ADJ=SIZE/800;const r=SCALE*SCALE_ADJ;W=width/r,H=height/r,L=round(-width/(2*r),4),R=round(width/(2*r),4),T=round(-height/(2*r),4),B=round(height/(2*r),4),setFeatures(),setLayers(),console.log(JSON.stringify({HASH:tokenData.hash,SCALE:SCALE,COLOR_RULE:COLOR_RULE,LAYER_N:LAYER_N,BASE_RULE:BASE_RULE,HUE_DIFF:HUE_DIFF,FORCE_GRADIENTS:FORCE_GRADIENTS,HARD_CURVES:HARD_CURVES,DASH_RATE:DASH_RATE.toPrecision(2),STREET_TURBULENCE:STREET_TURBULENCE,NOISE_DIVISOR:(NOISE_DIVISOR*SCALE).toPrecision(4),DENSITY:DENSITY,TURBULENCE:TURBULENCE,IGNORE_STREET_CAP:IGNORE_STREET_CAP,KINKED_STREET_FACTOR:KINKED_STREET_FACTOR,HARD_BORDER:HARD_BORDER,BORDER_BLEED:BORDER_BLEED,BORDER_DRIFT:(BORDER_DRIFT*SCALE).toPrecision(4),BORDER_THICKNESS:BORDER_THICKNESS.toPrecision(2),BORDER_PADDING:(BORDER_PADDING*SCALE).toPrecision(4),ROTATION:ROTATION.toPrecision(2),STRAIGHT_STREETS:STRAIGHT_STREETS,X_OFF:X_OFF,Y_OFF:Y_OFF,MISPRINT_ROTATION:MISPRINT_ROTATION,MAX_GRADIENT:MAX_GRADIENT,GRAIN:GRAIN,SMUDGE:SMUDGE,STAR_MAP:STAR_MAP,LOW_INK:LOW_INK,HUE_RULE:HUE_RULE,SHADOW_X:SHADOW_X,SHADOW_Y:SHADOW_Y,SHADOW_MAGNITUDE:SHADOW_MAGNITUDE},null,2)),console.log(LAYERS)}function draw(){noLoop();const r=Date.now();translate(width/2,height/2),scale(SCALE*SCALE_ADJ);const e=1.5*max(abs(X_OFF),abs(Y_OFF));rotate(MISPRINT_ROTATION),drawBackground(T-e,B+e,L-e,R+e),rotate(ROTATION),drawStreetGrid(X_OFF,Y_OFF),drawBorder(),console.log(Date.now()-r)}function setSize(){}function setFeatures(){TURBULENCE=prb(.15),STREET_TURBULENCE=prb(.1),IGNORE_STREET_CAP=prb(.1),HARD_CURVES=prb(.05),STRAIGHT_STREETS=prb(scaleModifier(.05,.1)),STAR_MAP=prb(.02),LOW_INK=prb(.01),SMUDGE=prb(.01)?rnd(30,100):0,KINKED_STREET_FACTOR=prb(.15)?rnd(QUARTER_PI/2,QUARTER_PI)*posOrNeg():0,NOISE_DIVISOR=rnd(150,750)/SCALE,DENSITY=chance([SCALE>=.8?.0025:.015,0],[.97,1],[.05,2]),DASH_RATE=prb(.125)?rnd(.05,.2):0,COLOR_RULE=chance([40,0],[15,1],[5,2],[11,3],[27,4],[SCALE>=1&&TURBULENCE?0:2,5]);const r=STREET_TURBULENCE||HARD_CURVES?10:map(SCALE,1.2,.2,1,15);LAYER_N=chance([r,1],[6,2],[36,3],[34,rndint(4,7)],[HARD_CURVES?0:10,rndint(7,10)],[HARD_CURVES?0:4,rndint(10,15)],[HARD_CURVES?0:1,30]),BASE_RULE=chance([LAYER_N<=4?20:0,"paper"],[LAYER_N<=4?20:0,"faded"],[LAYER_N<=4?15:0,"burnt"],[LAYER_N<=4?10:5,"bright"],[6,"whiteAndBlack"],[4,"blackAndWhite"],[SCALE<=.3?0:4,"neon"]),HUE_DIFF=chance([3,0],[2,20],[1,100],[2,120],[1,150],[3,180])*posOrNeg(),FORCE_GRADIENTS=prb(.02),MAX_GRADIENT=prb(.025)?rnd(720,3e3):200,INVERT_STREETS=!1,LIGHTEN_DARKS=!1,HUE_RULE=sample(["path","preset"]),1===COLOR_RULE?(HUE_DIFF=0,LAYER_N=chance([6,3],[1,4],[1,5]),BASE_RULE=chance([7,"bright"],[3,"whiteAndBlack"],[5,"blackAndWhite"],[5,"neon"])):3===COLOR_RULE?(BASE_RULE=chance([20,"burnt"],[5,"blackAndWhite"],[5,"neon"]),TURBULENCE=rnd()<.4,STREET_TURBULENCE=rnd()<.3,LIGHTEN_DARKS=!0):4===COLOR_RULE?(BASE_RULE=chance([20,"faded"],[30,"bright"],[10,"paper"],[30,"whiteAndBlack"]),LAYER_N=chance([25,3],[35,rndint(4,6)],[25,rndint(6,9)],[HARD_CURVES?0:10,rndint(9,15)],[HARD_CURVES?0:5,rndint(15,30)]),HUE_DIFF=chance([LAYER_N>=12?2:1,10],[4,20],[LAYER_N>=12?1:2,100],[3,120],[LAYER_N>=12?1:3,150],[3,180])*posOrNeg(),prb(.05)?(FORCE_GRADIENTS=!0,INVERT_STREETS=!0):prb(.5)&&LAYER_N<=4&&(INVERT_STREETS=!0)):5===COLOR_RULE&&(NOISE_DIVISOR=rnd(350,1e3)/SCALE,LAYER_N=50,BASE_RULE=chance([1,"paper"],[1,"faded"],[1,"bright"],[1,"whiteAndBlack"]),HUE_DIFF=chance([6,0],[2,20],[1,120],[1,180])*posOrNeg()),("blackAndWhite"===BASE_RULE||"neon"===BASE_RULE&&LAYER_N>2&&3!==COLOR_RULE)&&(HUE_DIFF=chance([1,0],[2,180])*posOrNeg()),2===LAYER_N&&["neon","burnt"].includes(BASE_RULE)&&(HUE_DIFF=chance([5,0],[1,100],[1,120],[1,150],[1,180])*posOrNeg());const e=scaleModifier(1,1.6)*(LOW_INK?.7:1);if(MIN_ST_W=.7*e,MAX_ST_W=1.3*e,GRAIN=rnd()<.5||["blackAndWhite","neon","burnt"].includes(BASE_RULE)?0:rnd(.2,.7),X_OFF=0,Y_OFF=0,MISPRINT_ROTATION=0,BORDER_BLEED=prb(.5),HARD_BORDER=BORDER_BLEED||prb(.8),BORDER_PADDING=chance([5,rnd(175,200)],[75,rnd(30,60)],[20,rnd(20,30)])/SCALE,BORDER_THICKNESS=map(SCALE,.2,1.2,1.6,2.8)+rnd(-.2,.2),BORDER_DRIFT=chance([5,0],[3,rnd(3)/SCALE],[1,rnd(3,BORDER_PADDING/2)/SCALE]),ROTATION=rnd(-5e-4,5e-4),X_OFF=rnd(-2,2)/SCALE,Y_OFF=rnd(-2,2)/SCALE,IS_MISPRINT=prb(.015),!HARD_BORDER&&BORDER_PADDING*SCALE<=30&&(BORDER_DRIFT=BORDER_PADDING-5/SCALE,HARD_BORDER=!1,BORDER_BLEED=!1),IS_MISPRINT){HARD_BORDER=!0,BORDER_BLEED=!0,BORDER_THICKNESS=rnd(1.4,3),BORDER_DRIFT=chance([5,0],[3,rnd(3)/SCALE],[1,rnd(3,BORDER_PADDING/2)/SCALE]);const r=prb(.333)?2:1;X_OFF=rnd(-250,250)/(r*SCALE),Y_OFF=rnd(-250,250)/(r*SCALE),MISPRINT_ROTATION=rnd(-QUARTER_PI,QUARTER_PI)/(4*r)}BORDER_DRIFT=min(180/SCALE,BORDER_DRIFT),SHADOW_X=5*posOrNeg(),SHADOW_Y=5*posOrNeg(),SHADOW_MAGNITUDE=chance([15,0],[80,1],[4,2],[MAX_GRADIENT>200?20:1,10])}LAYERS=[],NOISE_OFFSET=1e5;